#!/usr/bin/env sh

# Pre-push hook - æŽ¨é€å‰çš„å®Œæ•´æ£€æŸ¥
echo "ðŸš€ Running pre-push checks..."

# èŽ·å–æŽ¨é€ä¿¡æ¯
REMOTE=$1
URL=$2

# æ£€æŸ¥æ˜¯å¦æŽ¨é€åˆ° main åˆ†æ”¯
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "âš ï¸  Pushing to main branch ($CURRENT_BRANCH)"
  echo "   Running full test suite before push..."

  # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
  echo "ðŸ§ª Running full test suite..."
  START_TIME=$(date +%s%N)
  npm run test:run >/dev/null 2>&1
  TEST_STATUS=$?
  END_TIME=$(date +%s%N)
  TEST_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

  if [ $TEST_STATUS -ne 0 ]; then
    echo "âŒ Full test suite failed (${TEST_TIME}ms)"
    echo "   Please fix failing tests before pushing to main"
    exit 1
  fi
  echo "âœ… Full test suite passed (${TEST_TIME}ms)"

  # æ£€æŸ¥æµ‹è¯•è¦†ç›–çŽ‡
  echo "ðŸ“Š Checking test coverage..."
  COVERAGE_OUTPUT=$(npm run test:coverage 2>&1)
  COVERAGE_STATUS=$?

  if [ $COVERAGE_STATUS -ne 0 ]; then
    echo "âŒ Coverage check failed"
    exit 1
  fi

  # æå–è¦†ç›–çŽ‡æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
  COVERAGE_LINES=$(echo "$COVERAGE_OUTPUT" | grep -E "All files" | grep -oE "[0-9]+" | head -1)
  if [ -n "$COVERAGE_LINES" ] && [ "$COVERAGE_LINES" -lt 70 ]; then
    echo "âš ï¸  Test coverage is below 70% (current: ${COVERAGE_LINES}%)"
    echo "   Consider adding more tests before pushing to main"
  fi

else
  echo "ðŸ“¦ Pushing to branch: $CURRENT_BRANCH"
  echo "   Running basic checks (full tests run on CI/CD)"

  # éžä¸»åˆ†æ”¯åªè¿è¡Œå¿«é€Ÿæ£€æŸ¥
  echo "ðŸ§ª Running quick tests..."
  npm run test:unit --silent --run >/dev/null 2>&1
  QUICK_TEST_STATUS=$?

  if [ $QUICK_TEST_STATUS -ne 0 ]; then
    echo "âŒ Quick tests failed"
    echo "   Please fix failing tests before pushing"
    exit 1
  fi
  echo "âœ… Quick tests passed"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
  echo "âš ï¸  You have uncommitted changes"
  echo "   Consider committing them before push, or use 'git push --no-verify' to skip"
fi

# æ£€æŸ¥åˆ†æ”¯åç§°è§„èŒƒï¼ˆå¯é€‰ï¼‰
BRANCH_PATTERN="^(feat|fix|docs|style|refactor|test|chore|hotfix)\/[a-z0-9-]+$"
if ! echo "$CURRENT_BRANCH" | grep -qE "$BRANCH_PATTERN"; then
  echo "âš ï¸  Branch name doesn't follow conventional format"
  echo "   Recommended format: type/description (e.g., feat/add-node-dragging)"
  echo "   This is just a suggestion, not a requirement"
fi

# ç»Ÿè®¡æŽ¨é€ä¿¡æ¯
ZERO_COMMIT="0000000000000000000000000000000000000000"
COMMITS_TO_PUSH=$(git rev-list --count ${2:-origin/$CURRENT_BRANCH}..HEAD 2>/dev/null || echo "unknown")

if [ "$COMMITS_TO_PUSH" != "unknown" ] && [ "$COMMITS_TO_PUSH" -gt 5 ]; then
  echo "ðŸ“ˆ Pushing $COMMITS_TO_PUSH commits"
  echo "   Consider consolidating related commits for better history"
fi

echo "ðŸŽ‰ Pre-push checks completed successfully!"
echo ""
echo "ðŸ“‹ Push summary:"
echo "   Remote: $REMOTE"
echo "   Branch: $CURRENT_BRANCH"
echo "   Commits: $COMMITS_TO_PUSH"

exit 0