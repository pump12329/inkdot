#!/usr/bin/env sh

# Prepare commit message hook - è¾…åŠ©åˆ›å»ºè§„èŒƒçš„æäº¤ä¿¡æ¯
COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA=$3

# åªåœ¨æœªæŒ‡å®šæäº¤ä¿¡æ¯æ—¶æä¾›å¸®åŠ©
if [ "$COMMIT_SOURCE" = "message" ] || [ "$COMMIT_SOURCE" = "template" ] || [ "$COMMIT_SOURCE" = "" ]; then
  # æ£€æŸ¥å½“å‰æ–‡ä»¶å˜æ›´æ¥å»ºè®®æäº¤ç±»åž‹
  CURRENT_MSG=$(cat "$COMMIT_MSG_FILE" 2>/dev/null || echo "")

  # å¦‚æžœå·²ç»æœ‰å†…å®¹ï¼Œä¸æä¾›æ¨¡æ¿
  if [ -n "$CURRENT_MSG" ]; then
    exit 0
  fi

  # åˆ†æžæ–‡ä»¶å˜æ›´
  CHANGED_FILES=$(git diff --cached --name-only)
  HAS_VUE=$(echo "$CHANGED_FILES" | grep -E '\.vue$' | wc -l)
  HAS_TS=$(echo "$CHANGED_FILES" | grep -E '\.(ts|js)$' | wc -l)
  HAS_TEST=$(echo "$CHANGED_FILES" | grep -E 'test|spec' | wc -l)
  HAS_DOCS=$(echo "$CHANGED_FILES" | grep -E '\.md$' | wc -l)
  HAS_CONFIG=$(echo "$CHANGED_FILES" | grep -E '\.(json|yml|yaml|config\.js|vite\.config|vitest\.config)' | wc -l)

  # ç”Ÿæˆå»ºè®®çš„æäº¤ä¿¡æ¯
  SUGGESTION=""

  if [ "$HAS_TEST" -gt 0 ] && [ "$HAS_VUE" -eq 0 ] && [ "$HAS_TS" -eq 0 ]; then
    SUGGESTION="test: "
  elif [ "$HAS_DOCS" -gt 0 ] && [ "$HAS_VUE" -eq 0 ] && [ "$HAS_TS" -eq 0 ]; then
    SUGGESTION="docs: "
  elif [ "$HAS_CONFIG" -gt 0 ] && [ "$HAS_VUE" -eq 0 ] && [ "$HAS_TS" -eq 0 ]; then
    SUGGESTION="chore: update configuration"
  elif [ "$HAS_VUE" -gt 0 ] || [ "$HAS_TS" -gt 0 ]; then
    # å¦‚æžœæ˜¯ä»£ç å˜æ›´ï¼Œæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ä½†ä¸è‡ªåŠ¨å¡«å……
    echo "ðŸ’¡ Tip: Use conventional commit format"
    echo "   Examples:"
    echo "     feat(component): add new functionality"
    echo "     fix(bug): resolve issue with component"
    echo "     refactor(utils): improve code structure"
    echo ""
    exit 0
  fi

  # å¦‚æžœæœ‰æ˜Žç¡®çš„å»ºè®®ï¼Œå†™å…¥æäº¤ä¿¡æ¯æ–‡ä»¶
  if [ -n "$SUGGESTION" ]; then
    echo "$SUGGESTION" > "$COMMIT_MSG_FILE"
  fi
fi

exit 0