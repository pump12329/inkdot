#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ä¼˜åŒ–åçš„ pre-commit hook
echo "ğŸ” Running optimized pre-commit checks..."

# è·å–æ˜¯å¦æœ‰æš‚å­˜çš„ä»£ç æ–‡ä»¶
STAGED_CODE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(vue|js|ts|jsx|tsx)$' | wc -l)
STAGED_DOCS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.md$' | wc -l)

echo "ğŸ“Š Found $STAGED_CODE_FILES code files and $STAGED_DOCS_FILES documentation files staged"

# 1. å¿«é€Ÿæ ¼å¼åŒ–æ£€æŸ¥ (lint-staged) - å¹¶è¡Œæ‰§è¡Œ
echo "ğŸ“ Step 1: Running lint-staged (parallel execution)..."
START_TIME=$(date +%s%N)
npx lint-staged --quiet
LINT_STATUS=$?
END_TIME=$(date +%s%N)
LINT_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

if [ $LINT_STATUS -ne 0 ]; then
  echo "âŒ Lint-staged failed (${LINT_TIME}ms)"
  exit 1
fi
echo "âœ… Lint-staged passed (${LINT_TIME}ms)"

# 2. TypeScript ç±»å‹æ£€æŸ¥ - åªåœ¨æœ‰ä»£ç æ–‡ä»¶å˜æ›´æ—¶æ‰§è¡Œ
if [ $STAGED_CODE_FILES -gt 0 ]; then
  echo "ğŸ”§ Step 2: TypeScript type checking..."
  START_TIME=$(date +%s%N)
  npm run type-check --silent
  TS_STATUS=$?
  END_TIME=$(date +%s%N)
  TS_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

  if [ $TS_STATUS -ne 0 ]; then
    echo "âŒ TypeScript check failed (${TS_TIME}ms)"
    exit 1
  fi
  echo "âœ… TypeScript check passed (${TS_TIME}ms)"
else
  echo "â­ï¸  Skipping TypeScript check (no code files changed)"
fi

# 3. æ„å»ºæ£€æŸ¥ - åªåœ¨æœ‰ä»£ç æ–‡ä»¶å˜æ›´æ—¶æ‰§è¡Œï¼Œä¸”ä½¿ç”¨ç¼“å­˜
if [ $STAGED_CODE_FILES -gt 0 ]; then
  echo "ğŸ—ï¸  Step 3: Optimized build verification..."
  START_TIME=$(date +%s%N)

  # æ£€æŸ¥æ˜¯å¦æœ‰æ„å»ºç¼“å­˜
  if [ -d "dist" ] && [ "$STAGED_CODE_FILES" -lt 5 ]; then
    echo "ğŸ“¦ Using incremental build (few files changed)"
    npm run build --silent >/dev/null 2>&1
  else
    npm run build --silent
  fi

  BUILD_STATUS=$?
  END_TIME=$(date +%s%N)
  BUILD_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

  if [ $BUILD_STATUS -ne 0 ]; then
    echo "âŒ Build check failed (${BUILD_TIME}ms)"
    exit 1
  fi
  echo "âœ… Build check passed (${BUILD_TIME}ms)"
else
  echo "â­ï¸  Skipping build check (no code files changed)"
fi

# 4. å¿«é€Ÿæµ‹è¯• - åªåœ¨æœ‰ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶æ‰§è¡Œ
if [ $STAGED_CODE_FILES -gt 0 ]; then
  echo "ğŸ§ª Step 4: Quick unit tests..."
  START_TIME=$(date +%s%N)
  npm run test:unit --silent --run
  TEST_STATUS=$?
  END_TIME=$(date +%s%N)
  TEST_TIME=$(( ($END_TIME - $START_TIME) / 1000000 ))

  if [ $TEST_STATUS -ne 0 ]; then
    echo "âŒ Unit tests failed (${TEST_TIME}ms)"
    exit 1
  fi
  echo "âœ… Unit tests passed (${TEST_TIME}ms)"
else
  echo "â­ï¸  Skipping unit tests (no code files changed)"
fi

# è®¡ç®—æ€»è€—æ—¶
TOTAL_END_TIME=$(date +%s%N)
TOTAL_TIME=$(( ($TOTAL_END_TIME - $(echo "$START_TIME" | sed 's/[^0-9]//g')) * -1 / 1000000 ))
echo "ğŸ‰ All pre-commit checks passed! Total time: ${TOTAL_TIME}ms"
echo ""
echo "ğŸ’¡ Tips:"
echo "   - Full test suite: npm run test:run"
echo "   - Coverage report: npm run test:coverage"
echo "   - E2E tests: npm run test:e2e"