#!/usr/bin/env sh

# æäº¤ä¿¡æ¯è§„èŒƒæ£€æŸ¥
echo "ğŸ“ Checking commit message format..."

# è·å–æäº¤ä¿¡æ¯
COMMIT_MSG_FILE=$1

# æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æä¾›
if [ -z "$COMMIT_MSG_FILE" ]; then
  echo "âŒ Commit message file not provided"
  exit 1
fi

# è¯»å–æäº¤ä¿¡æ¯
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
else
  echo "âŒ Commit message file not found: $COMMIT_MSG_FILE"
  exit 1
fi

# å®šä¹‰æäº¤ä¿¡æ¯æ ¼å¼è§„åˆ™
# æ ¼å¼: type(scope): description
# ç±»å‹: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert, WIP

# æ£€æŸ¥æ˜¯å¦ä¸ºç©º
if [ -z "$COMMIT_MSG" ]; then
  echo "âŒ Commit message cannot be empty"
  exit 1
fi

# æ£€æŸ¥é•¿åº¦ï¼ˆç¬¬ä¸€è¡Œä¸è¶…è¿‡72å­—ç¬¦ï¼‰
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n1)
if [ ${#FIRST_LINE} -gt 72 ]; then
  echo "âŒ First line of commit message should be 72 characters or less"
  echo "   Current length: ${#FIRST_LINE} characters"
  exit 1
fi

# æ£€æŸ¥ä»¥WIPå¼€å¤´çš„æäº¤ä¿¡æ¯ï¼ˆå·¥ä½œè¿›è¡Œä¸­ï¼‰
if echo "$FIRST_LINE" | grep -q "^WIP"; then
  echo "âš ï¸  Work in progress commit detected"
  echo "   Make sure to finalize this before merging"
  exit 0
fi

# æ£€æŸ¥åŸºæœ¬æ ¼å¼
if ! echo "$FIRST_LINE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,72}"; then
  echo "âŒ Invalid commit message format"
  echo ""
  echo "   Expected format: type(scope): description"
  echo "   Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
  echo ""
  echo "   Examples:"
  echo "     feat(mindmap): add node drag functionality"
  echo "     fix(canvas): resolve zoom issue on mobile"
  echo "     docs(api): update endpoint documentation"
  echo "     test(components): add unit tests for MindMapNode"
  echo ""
  echo "   Current message: $FIRST_LINE"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æè¿°å†…å®¹
if echo "$FIRST_LINE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?:\s*$"; then
  echo "âŒ Commit message cannot end with ':'"
  echo "   Please add a description after the type"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦ä»¥å¥å·ç»“å°¾ï¼ˆä¸åº”è¯¥ï¼‰
if echo "$FIRST_LINE" | grep -q "\.$"; then
  echo "âš ï¸  Commit message should not end with a period"
  echo "   Consider removing the trailing period"
fi

# æ£€æŸ¥å¤šè¡Œæäº¤ä¿¡æ¯çš„æ ¼å¼
# æ›´å®‰å…¨çš„æ–¹å¼è·å–æ­£æ–‡è¡Œ
if echo "$COMMIT_MSG" | grep -q '^$'; then
  BODY_LINES=$(echo "$COMMIT_MSG" | tail -n +2 | grep -v "^$")
else
  BODY_LINES=""
fi

if [ -n "$BODY_LINES" ]; then
  # æ£€æŸ¥æ˜¯å¦æœ‰ç©ºè¡Œåˆ†éš”æ ‡é¢˜å’Œæ­£æ–‡
  SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
  if [ -n "$SECOND_LINE" ]; then
    echo "âš ï¸  Consider adding a blank line between subject and body"
  fi

  # æ£€æŸ¥æ­£æ–‡è¡Œé•¿åº¦
  LONG_LINES=$(echo "$COMMIT_MSG" | tail -n +2 | grep -E ".{81,}")
  if [ -n "$LONG_LINES" ]; then
    echo "âš ï¸  Some lines in commit body exceed 80 characters"
    echo "   Consider wrapping them for better readability"
  fi
fi

echo "âœ… Commit message format is valid"

# æå–æäº¤ç±»å‹å’ŒèŒƒå›´ä»¥æä¾›é¢å¤–æ£€æŸ¥
COMMIT_TYPE=$(echo "$FIRST_LINE" | sed -E 's/^([a-z]+)(\([^)]*\))?:.*/\1/')
COMMIT_SCOPE=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+\(([^)]*)\):.*/\1/' | grep -v '^[a-z]*$')

# æ ¹æ®æäº¤ç±»å‹æä¾›å»ºè®®
case $COMMIT_TYPE in
  "feat")
    echo "ğŸ’¡ Feature commit detected - make sure to update tests if applicable"
    ;;
  "fix")
    echo "ğŸ› Bug fix commit - consider adding regression tests"
    ;;
  "refactor")
    echo "ğŸ”§ Refactor commit - ensure no functional changes"
    ;;
  "test")
    echo "ğŸ§ª Test commit - consider updating test coverage"
    ;;
  "docs")
    echo "ğŸ“š Documentation commit - consider updating changelog if needed"
    ;;
  "chore")
    echo "ğŸ”¨ Chore commit - build tooling or dependency updates"
    ;;
esac

exit 0